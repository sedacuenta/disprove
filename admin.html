<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Disprove</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/15189/15189214.png">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=stars" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: #f1f1f1;
            padding: 0 20px;
        }

        h1,
        h2 {
            text-align: center;
            margin-top: 20px;
        }

        #loginAdmin,
        #panel {
            max-width: 800px;
            margin: auto;
        }

        #loginAdmin {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 50px;
        }

        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            width: 100%;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: #ff5722;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
        }

        tr:hover {
            background: #222;
        }

        .btn-small {
            padding: 5px 8px;
            font-size: .9rem;
            background: #2196f3;
        }

        .btn-delete {
            background: #e53935;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        .close {
            float: right;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
    </style>
</head>

<body>
    <header>
        <h1><a href="/" class="a_title">Dis-prove</a></h1>
        <p>Porque la tecnolog√≠a es para todos</p>
        <div class="credentials" id="credentials-box">
            <button onclick="window.location.href='/login.html'">Login</button>
            <button onclick="window.location.href='/register.html'">Register</button>
        </div>
        <button id="admin-btn" onclick="window.location.href='/admin.html'">
            <span class="material-symbols-outlined">stars</span>
        </button>
        <button id="logout-btn" style="display:none;">Cerrar sesi√≥n</button>
    </header>

    <h1>Panel de Administrador</h1>

    <div id="loginAdmin">
        <input id="admin_email" type="email" placeholder="Admin email">
        <input id="admin_pass" type="password" placeholder="Admin password">
        <button id="btn-admin-login">Entrar</button>
    </div>

    <div id="panel" style="display:none;">
        <h2>Usuarios registrados</h2>
        <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usuarios"></tbody>
        </table>
    </div>

    <!-- Modal cambiar contrase√±a -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h3>Cambiar contrase√±a</h3>
            <input id="new_pass" type="password" placeholder="Nueva contrase√±a">
            <button id="btn-guardar-pass">Guardar</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        window.addEventListener('DOMContentLoaded', () => {

            // ================= FIREBASE =================
            const firebaseConfig = {
                apiKey: "AIzaSyC5urY-iP2m4Eqi9c3WcvjrfHMDnxwD7ic",
                authDomain: "disprove-afcb8.firebaseapp.com",
                projectId: "disprove-afcb8",
                storageBucket: "disprove-afcb8.firebasestorage.app",
                messagingSenderId: "721347672126",
                appId: "1:721347672126:web:d37be05d262bceb27ef96f"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // ================= ADMIN LOGIN SIN HASH =================
            const SUPER_ADMIN = {
                email: "shunlai.chen@disproveweb.com",
                pass_plain: "Cuenta3434" // ‚Üê contrase√±a en texto plano temporal
            };

            let usuarioSeleccionado = null;

            // LOGIN ADMIN
            document.getElementById("btn-admin-login").addEventListener("click", () => {
                const email = document.getElementById("admin_email").value.trim();
                const pass = document.getElementById("admin_pass").value.trim();

                if (email === SUPER_ADMIN.email && pass === SUPER_ADMIN.pass_plain) {
                    document.getElementById("loginAdmin").style.display = "none";
                    document.getElementById("panel").style.display = "block";
                    cargarUsuarios();
                } else {
                    alert("No autorizado");
                }
            });

            // ================= LISTAR USUARIOS =================
            async function cargarUsuarios() {
                const tabla = document.getElementById("usuarios");
                tabla.innerHTML = "";

                const snapshot = await db.collection("usuarios").get();
                snapshot.forEach(doc => {
                    const u = doc.data();
                    tabla.innerHTML += `
            <tr>
                <td>${u.email}</td>
                <td>${u.nombre}</td>
                <td>
                    <button class="btn-small" onclick="abrirModal('${u.email}')">Cambiar contrase√±a</button>
                    <button class="btn-delete btn-small" onclick="eliminarUsuario('${u.email}')">Eliminar</button>
                </td>
            </tr>`;
                });
            }

            // ELIMINAR USUARIO
            window.eliminarUsuario = async function (email) {
                if (confirm(`¬øEliminar usuario ${email}?`)) {
                    await db.collection("usuarios").doc(email).delete();
                    cargarUsuarios();
                }
            }

            // ================= EDITAR CONTRASE√ëA =================
            window.abrirModal = function (email) {
                usuarioSeleccionado = email;
                document.getElementById("modal").style.display = "flex";
            }
            window.cerrarModal = function () {
                usuarioSeleccionado = null;
                document.getElementById("new_pass").value = "";
                document.getElementById("modal").style.display = "none";
            }
            document.getElementById("btn-guardar-pass").addEventListener("click", async () => {
                const nueva = document.getElementById("new_pass").value.trim();
                if (!nueva) { alert("Introduce la nueva contrase√±a"); return; }

                await db.collection("usuarios").doc(usuarioSeleccionado).update({ pass: nueva });
                alert("Contrase√±a actualizada ‚úî");
                cerrarModal();
            });

        });

        // Guardar sesi√≥n si el login es correcto
        if (bcrypt.compareSync(pass, hash)) {
            alert("‚úî Inicio de sesi√≥n correcto");
            localStorage.setItem("usuario", email);
            location.reload(); // Recarga y aplica cambios de UI
        }
        else alert("‚ùå Contrase√±a incorrecta");

        // üî• Control de interfaz seg√∫n sesi√≥n
        window.addEventListener("DOMContentLoaded", () => {
            const usuario = localStorage.getItem("usuario");

            if (usuario) {
                document.getElementById("credentials-box").style.display = "none";
                document.getElementById("logout-btn").style.display = "inline-block";
            }
        });

        // üî• Cerrar sesi√≥n
        document.getElementById("logout-btn").addEventListener("click", () => {
            localStorage.removeItem("usuario");
            location.reload(); // Vuelve a mostrar Login/Register
        });

    </script>
</body>

</html>