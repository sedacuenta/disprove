<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Admin - Disprove</title>
<link rel="stylesheet" href="styles.css" />
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/15189/15189214.png" />
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=stars" />
<style>
  /* --- Básico (puedes mover a styles.css) --- */
  body { font-family: Inter, Arial, sans-serif; background:#0f1113; color:#e6eef6; margin:0; padding:18px; }
  header { display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:18px; }
  header h1 { margin:0; font-size:1.1rem; }
  .credentials { display:flex; gap:8px; }
  button { background:#ff6a2b; border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .small { padding:6px 8px; font-size:.9rem; }
  .container { max-width:1100px; margin:0 auto; }
  #loginAdmin, #panel { background:#0b0c0d; padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.6); }
  #loginAdmin { max-width:420px; margin:20px auto; display:grid; gap:10px; }
  input[type="email"], input[type="password"], input[type="text"], select { width:100%; padding:10px; border-radius:8px; border:1px solid #222; background:#0b0c0d; color:#e6eef6; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { padding:10px; border-bottom:1px solid #1b1b1b; text-align:left; font-size:.95rem; }
  th { color:#9fb5d9; }
  tr:hover { background:#0b141f; }
  .row { display:flex; gap:12px; align-items:center; }
  .stats { display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
  .card { background:#0b1220; padding:12px; border-radius:10px; min-width:160px; box-shadow:0 4px 12px rgba(0,0,0,.6); }
  canvas { width:100%; height:140px; }
  .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
  .muted { color:#9fb5d9; font-size:.9rem; }
  .danger { background:#b02a2a; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <h1><a href="/" class="a_title" style="color:inherit;text-decoration:none">Dis-prove</a></h1>
      <div class="muted">Panel de administración</div>
    </div>

    <div class="right">
      <div id="auth-area" class="credentials">
        <button id="open-login">Admin Login</button>
      </div>
      <button id="btn-logout" style="display:none">Cerrar sesión</button>
    </div>
  </header>

  <!-- LOGIN ADMIN (modal-like simple) -->
  <div id="loginAdmin" style="display:none">
    <h2>Iniciar sesión (Admin)</h2>
    <input id="admin_email" type="email" placeholder="email@ejemplo.com" />
    <input id="admin_pass"  type="password" placeholder="Contraseña" />
    <div style="display:flex;gap:8px;">
      <button id="btn-admin-login" class="small">Entrar</button>
      <button id="btn-cancel-login" class="small">Cancelar</button>
    </div>
    <div id="login-msg" class="muted"></div>
  </div>

  <!-- PANEL (oculto hasta login correcto) -->
  <div id="panel" style="display:none; margin-top:18px;">
    <div class="row" style="align-items:baseline">
      <h2 style="margin:0">Usuarios registrados</h2>
      <div class="right">
        <div class="muted" id="stats-summary">Cargando...</div>
        <button id="refresh-btn" class="small">Actualizar</button>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats" id="stats-area" style="margin-top:14px">
      <div class="card">
        <div class="muted">Total usuarios</div>
        <div id="stat-total" style="font-size:1.6rem; font-weight:700">—</div>
      </div>
      <div class="card">
        <div class="muted">Admins</div>
        <div id="stat-admins" style="font-size:1.6rem; font-weight:700">—</div>
      </div>
      <div class="card" style="flex:1">
        <div class="muted">Distribución por roles</div>
        <canvas id="rolesChart"></canvas>
      </div>
    </div>

    <!-- Tabla usuarios -->
    <table id="users-table" aria-live="polite">
      <thead>
        <tr><th>Email</th><th>Nombre</th><th>Role</th><th style="text-align:right">Acciones</th></tr>
      </thead>
      <tbody id="usuarios"></tbody>
    </table>

    <div style="margin-top:12px" class="muted">Todas las acciones quedan registradas en <code>admin_logs</code>.</div>
  </div>
</div>

<!-- Modal RESET -->
<div id="modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center;">
  <div style="background:#0b1220; padding:18px; border-radius:10px; width:320px; text-align:center;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Restablecer contraseña</h3>
      <button onclick="cerrarModal()" style="background:none;border:none;color:#fff;font-weight:bold;font-size:18px;cursor:pointer">&times;</button>
    </div>
    <p class="muted" id="modal-target" style="margin-top:12px">Se enviará un email a <b id="modal-email">—</b></p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="btn-enviar-reset" class="small">Enviar Email</button>
      <button onclick="cerrarModal()" class="small">Cancelar</button>
    </div>
    <div id="modal-msg" class="muted" style="margin-top:10px"></div>
  </div>
</div>

<script type="module">
/* ===================================================================
   Admin panel completo usando Firebase modular (v11 compatible imports)
   - Solo administradores permitidos (ALLOWED_ADMINS or role === 'admin')
   - Logs en 'admin_logs'
   - Users in 'usuarios' collection
   - Reset de contraseña real vía sendPasswordResetEmail
   - Stats and simple canvas chart
   =================================================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, setDoc, query, where
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// --- CONFIG --- (usa tu propio config)
const firebaseConfig = {
  apiKey: "AIzaSyC5urY-iP2m4Eqi9c3WcvjrfHMDnxwD7ic",
  authDomain: "disprove-afcb8.firebaseapp.com",
  projectId: "disprove-afcb8",
  storageBucket: "disprove-afcb8.firebasestorage.app",
  messagingSenderId: "721347672126",
  appId: "1:721347672126:web:d37be05d262bceb27ef96f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- ADMIN CONTROL: lista blanca de emails de administradores
// AÑADE aquí los emails de los administradores iniciales
const ALLOWED_ADMINS = ["shunlai.chen@disproveweb.com"];

// --- DOM refs
const openLoginBtn = document.getElementById("open-login");
const loginPanel = document.getElementById("loginAdmin");
const btnAdminLogin = document.getElementById("btn-admin-login");
const btnCancelLogin = document.getElementById("btn-cancel-login");
const btnLogout = document.getElementById("btn-logout");
const authArea = document.getElementById("auth-area");
const panel = document.getElementById("panel");
const usuariosTbody = document.getElementById("usuarios");
const statTotal = document.getElementById("stat-total");
const statAdmins = document.getElementById("stat-admins");
const rolesChart = document.getElementById("rolesChart").getContext("2d");
const refreshBtn = document.getElementById("refresh-btn");

// modal refs
const modal = document.getElementById("modal");
const modalEmail = document.getElementById("modal-email");
const modalMsg = document.getElementById("modal-msg");
const btnEnviarReset = document.getElementById("btn-enviar-reset");

let currentAdminUser = null;
let selectedTargetEmail = null;

// small utility for logs
async function writeLog(adminEmail, action, targetEmail = null, details = null){
  try{
    const entry = {
      admin: adminEmail || "unknown",
      action,
      target: targetEmail || null,
      details: details || null,
      ts: new Date().toISOString()
    };
    await setDoc(doc(collection(db, "admin_logs"), `${Date.now()}_${Math.random().toString(36).slice(2,9)}`), entry);
  }catch(e){
    console.error("Log error", e);
  }
}

// show/hide login UI
openLoginBtn.onclick = () => {
  loginPanel.style.display = loginPanel.style.display === "none" ? "grid" : "none";
};
btnCancelLogin.onclick = () => loginPanel.style.display = "none";

// admin login via Firebase Auth (admin must be a Firebase Auth user)
btnAdminLogin.onclick = async () => {
  const email = document.getElementById("admin_email").value.trim();
  const pass  = document.getElementById("admin_pass").value.trim();
  if(!email || !pass) { alert("Completa email y contraseña"); return; }
  try{
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    // onAuthStateChanged will handle permission check and UI
    console.log("Cred OK", cred.user.email);
  }catch(e){
    alert("Error login: " + e.message);
  }
};

// logout (for admin)
btnLogout.onclick = async () => {
  await signOut(auth);
  currentAdminUser = null;
  panel.style.display = "none";
  document.getElementById("credentials-box").style.display = "flex";
  btnLogout.style.display = "none";
  loginPanel.style.display = "none";
  await writeLog("system", "admin_logout", null, "Admin logged out");
};

// auth state observer: allow access only if admin
onAuthStateChanged(auth, async (user) => {
  if(!user){
    // no one logged in
    currentAdminUser = null;
    panel.style.display = "none";
    document.getElementById("credentials-box").style.display = "flex";
    btnLogout.style.display = "none";
    return;
  }

  // user signed in: check if allowed
  const email = user.email;
  let allowed = ALLOWED_ADMINS.includes(email.toLowerCase());

  // also check users collection role
  try{
    const q = query(collection(db, "usuarios"), where("email", "==", email));
    const snap = await getDocs(q);
    snap.forEach(d=>{
      const data = d.data();
      if(data && data.role && data.role.toLowerCase() === "admin") allowed = true;
    });
  }catch(e){ console.error("check role error", e); }

  if(!allowed){
    // not admin: sign out and show message
    alert("No autorizado para entrar al panel. Contacta con el propietario.");
    await signOut(auth);
    return;
  }

  // admin authorized
  currentAdminUser = user;
  loginPanel.style.display = "none";
  document.getElementById("credentials-box").style.display = "none";
  btnLogout.style.display = "inline-block";
  panel.style.display = "block";
  await writeLog(email, "admin_login", null, "Admin accessed panel");
  await refreshAll();
});

// Refresh: load users, stats
async function refreshAll(){
  try{
    // load users
    usuariosTbody.innerHTML = "<tr><td colspan='4' class='muted'>Cargando...</td></tr>";
    const snap = await getDocs(collection(db, "usuarios"));
    const list = [];
    snap.forEach(d => {
      list.push( { id: d.id, ...d.data() } );
    });

    // sort by email
    list.sort((a,b)=> (a.email||"").localeCompare(b.email||""));

    usuariosTbody.innerHTML = "";
    const roleCount = {};
    let adminCount = 0;
    list.forEach(u=>{
      const role = (u.role || "user").toLowerCase();
      roleCount[role] = (roleCount[role]||0)+1;
      if(role==="admin") adminCount++;

      usuariosTbody.innerHTML += `
        <tr>
          <td style="width:38%">${escapeHtml(u.email||"")}</td>
          <td style="width:34%">${escapeHtml(u.nombre||"")}</td>
          <td style="width:14%">
            <select data-email="${escapeHtml(u.email)}" class="role-select">
              <option value="user" ${role==="user" ? "selected":""}>user</option>
              <option value="editor" ${role==="editor" ? "selected":""}>editor</option>
              <option value="admin" ${role==="admin" ? "selected":""}>admin</option>
            </select>
          </td>
          <td style="width:14%; text-align:right">
            <button class="small" data-reset="${escapeHtml(u.email)}">Reset pwd</button>
            <button class="small danger" data-delete="${escapeHtml(u.email)}">Eliminar</button>
          </td>
        </tr>`;
    });

    statTotal.textContent = list.length;
    statAdmins.textContent = adminCount;

    // attach listeners for role selects, reset and delete
    document.querySelectorAll(".role-select").forEach(el=>{
      el.onchange = async (ev)=>{
        const newRole = ev.target.value;
        const targetEmail = ev.target.getAttribute("data-email");
        try{
          await updateDoc(doc(db,"usuarios", targetEmail), { role: newRole });
          await writeLog(currentAdminUser.email, "change_role", targetEmail, `role->${newRole}`);
          refreshBtn.disabled = false;
          refreshVisualization(roleCount, newRole, targetEmail);
          alert("Rol actualizado");
          await refreshAll(); // quick refresh to update counts
        }catch(e){ alert("Error updating role: "+e.message); }
      };
    });

    document.querySelectorAll("[data-delete]").forEach(btn=>{
      btn.onclick = async (ev)=>{
        const targetEmail = btn.getAttribute("data-delete");
        if(!confirm(`Eliminar usuario ${targetEmail} (solo documento Firestore). Continuar?`)) return;
        try{
          await deleteDoc(doc(db,"usuarios", targetEmail));
          await writeLog(currentAdminUser.email, "delete_user", targetEmail, null);
          alert("Usuario eliminado");
          await refreshAll();
        }catch(e){ alert("Error: "+e.message); }
      };
    });

    document.querySelectorAll("[data-reset]").forEach(btn=>{
      btn.onclick = (ev)=>{
        selectedTargetEmail = btn.getAttribute("data-reset");
        modalEmail.textContent = selectedTargetEmail;
        modal.style.display = "flex";
        modalMsg.textContent = "";
      };
    });

    // draw chart
    drawRolesChart(roleCount);

  }catch(e){
    console.error(e);
    alert("Error cargando usuarios: " + (e.message || e));
  }
}

refreshBtn.onclick = refreshAll;

// send reset email
btnEnviarReset.onclick = async () => {
  if(!selectedTargetEmail) return;
  modalMsg.textContent = "Enviando...";
  try{
    await sendPasswordResetEmail(auth, selectedTargetEmail);
    await writeLog(currentAdminUser.email, "send_password_reset", selectedTargetEmail, null);
    modalMsg.textContent = "Email enviado ✔";
    setTimeout(()=>{ modal.style.display = "none"; modalMsg.textContent = ""; }, 1200);
  }catch(e){
    modalMsg.textContent = "Error: " + e.message;
  }
};

function cerrarModal(){ modal.style.display = "none"; selectedTargetEmail = null; }

// small utility: safe text
function escapeHtml(str = ""){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// draw a simple bar chart for roles (canvas)
function drawRolesChart(roleCount){
  // convert to arrays
  const keys = Object.keys(roleCount);
  const values = keys.map(k=>roleCount[k]);
  const canvas = document.getElementById("rolesChart");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  // resize for high DPI
  const W = canvas.width = canvas.clientWidth;
  const H = canvas.height = 140;
  ctx.clearRect(0,0,W,H);
  // simple bars
  const pad = 16;
  const barW = (W - pad*2) / Math.max(values.length,1);
  const maxV = Math.max(...values,1);
  keys.forEach((k,i)=>{
    const v = values[i];
    const x = pad + i*barW + 8;
    const h = (v / maxV) * (H - 40);
    const y = H - h - 20;
    ctx.fillStyle = (k==="admin" ? "#f39c12" : k==="editor" ? "#3498db" : "#2ecc71");
    ctx.fillRect(x, y, barW - 20, h);
    ctx.fillStyle = "#9fb5d9";
    ctx.font = "12px Inter, Arial";
    ctx.fillText(k, x, H - 4);
    ctx.fillText(String(v), x, y - 6);
  });
}

// quick update helper (not necessary but kept)
function refreshVisualization(roleCount, newRole, targetEmail){
  // can recalc roleCount quickly if desired
}

// auto-open login panel if not logged and admin button clicked
document.getElementById("admin-btn").onclick = () => {
  loginPanel.style.display = "grid";
  window.scrollTo({ top: 0, behavior: "smooth" });
};

</script>
</body>
</html>
